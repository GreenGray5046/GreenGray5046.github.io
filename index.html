<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<style>
* { margin:0; padding:0; box-sizing:border-box; font-family:'Times New Roman', Times, serif; }
body { background:#fff; color:#000; min-height:100vh; padding:20px; display:flex; justify-content:center; }
.container { max-width:1000px; width:100%; background:#fff; padding:25px; border:2px solid #000; }
h1 { text-align:center; margin-bottom:20px; font-size:2rem; text-decoration:underline; }
.game-info { display:flex; justify-content:space-between; margin-bottom:16px; gap:8px; flex-wrap:wrap; }
.score, .timer { background:#f0f0f0; padding:10px 14px; font-weight:bold; border:1px solid #000; }
.cipher-container { background:#f8f8f8; padding:18px; border:1px solid #000; }
.cipher-row { display:flex; flex-wrap:wrap; justify-content:center; margin-bottom:8px; }
.cipher-char-container { display:flex; flex-direction:column; align-items:center; margin:0 3px; }
.cipher-char { width:36px; text-align:center; font-size:1.6rem; letter-spacing:2px; }
.cipher-input { width:36px; text-align:center; border:1px solid #000; font-size:1.2rem; height:32px; text-transform:uppercase; }
.space-block { width:20px; margin:0 3px; }
.controls { display:flex; gap:12px; justify-content:center; flex-wrap:wrap; margin:12px 0 14px 0; }
button { background:#f0f0f0; border:1px solid #000; padding:10px 16px; cursor:pointer; font-weight:bold; }
.frequency-chart-container { background:#f8f8f8; padding:12px; margin-top:16px; height:260px; border:1px solid #000; }
.solution-container { background:#f8f8f8; padding:12px; margin-top:16px; display:none; border:1px solid #000; }
.solution-text { font-size:1.2rem; text-align:center; }
.author { text-align:right; font-style:italic; margin-top:8px; font-size:1rem; }
</style>
</head>
<body>
<div class="container">

<h1>Aristocrat Cipher Game</h1>

<div class="game-info">
    <div class="score">Score: <span id="score-value">0</span></div>
    <div class="timer">Time: <span id="timer-value">00:00</span></div>
</div>

<div class="cipher-container">
    <div class="cipher-row" id="cipher-letters"></div>
    <div class="cipher-row" id="cipher-inputs"></div>
    <div class="controls">
        <button id="new-quote-btn">New Quote</button>
        <button id="solve-btn">Solve</button>
    </div>
</div>

<div class="frequency-chart-container">
    <canvas id="frequency-chart"></canvas>
</div>

<div class="solution-container" id="solution-container">
    <div class="solution-text" id="solution-text"></div>
    <div class="author" id="author"></div>
</div>

</div>

<script>
// ==== Wikiquote API ====
var WikiquoteApi = (function() {
    var wqa = {};
    var API_URL = "https://en.wikiquote.org/w/api.php";

    wqa.queryTitles = function(titles, success, error) {
        $.ajax({
            url: API_URL,
            dataType: "jsonp",
            data: { format:"json", action:"query", redirects:"", titles:titles },
            success: function(result){
                var pages = result.query.pages;
                for(var p in pages){
                    if(!("missing" in pages[p])){
                        success(pages[p].pageid);
                        return;
                    }
                }
                error("No results");
            },
            error: function(){ error("Query failed"); }
        });
    };

    wqa.getSectionsForPage = function(pageId, success, error) {
        $.ajax({
            url: API_URL,
            dataType:"jsonp",
            data:{format:"json", action:"parse", prop:"sections", pageid:pageId},
            success:function(result){
                var sections=[];
                for(var s in result.parse.sections){
                    var num = result.parse.sections[s].number.split('.');
                    if(num[0]==="1" && num.length>1) sections.push(result.parse.sections[s].index);
                }
                if(sections.length===0) sections.push("1");
                success({sections:sections, titles:result.parse.title});
            },
            error:function(){ error("Sections failed"); }
        });
    };

    wqa.getQuotesForSection = function(pageId, sectionIndex, success, error) {
        $.ajax({
            url: API_URL,
            dataType:"jsonp",
            data:{format:"json", action:"parse", pageid:pageId, section:sectionIndex, noimages:""},
            success:function(result){
                var quotes=[];
                var $lis=$(result.parse.text["*"]).find('li:not(li li)');
                $lis.each(function(){
                    $(this).children().remove(':not(b)');
                    var $b=$(this).find('b');
                    quotes.push($b.length>0?$b.text():$(this).text());
                });
                success({quotes:quotes, titles:result.parse.title});
            },
            error:function(){ error("Quotes failed"); }
        });
    };

    wqa.getRandomQuote = function(author, success, error) {
        var fallbackError = function(msg){ error(msg); };
        var chooseQuote = function(quotes){
            var filtered = quotes.quotes.filter(q=>q.length<=80);
            if(filtered.length===0){ fallbackError("All quotes too long"); return; }
            var q = filtered[Math.floor(Math.random()*filtered.length)];
            success({quote:q, titles:quotes.titles});
        };
        var getQuotes=function(pageId, sections){
            var idx = sections.sections[Math.floor(Math.random()*sections.sections.length)];
            wqa.getQuotesForSection(pageId, idx, chooseQuote, fallbackError);
        };
        var getSections=function(pageId){
            wqa.getSectionsForPage(pageId, getQuotes, fallbackError);
        };
        wqa.queryTitles(author, getSections, fallbackError);
    };
    return wqa;
}());

// ==== Game state ====
const game = {score:0, time:0, timer:null, solution:"", author:"", cipherText:"", mapping:{}, chart:null};

// DOM
const lettersDiv = document.getElementById("cipher-letters");
const scoreValue = document.getElementById("score-value");
const timerValue = document.getElementById("timer-value");
const solutionContainer = document.getElementById("solution-container");
const solutionText = document.getElementById("solution-text");
const authorText = document.getElementById("author");

// ==== Chart ====
function initChart(){
    game.chart = new Chart(document.getElementById("frequency-chart"),{
        type:"bar", data:{labels:[], datasets:[{data:[]}]}, options:{responsive:true, maintainAspectRatio:false}
    });
}
function updateChart(){
    const freq={};
    for(const ch of game.cipherText) if(ch!==" ") freq[ch]=(freq[ch]||0)+1;
    const arr=Object.entries(freq).sort((a,b)=>b[1]-a[1]);
    game.chart.data.labels=arr.map(e=>e[0]);
    game.chart.data.datasets[0].data=arr.map(e=>e[1]);
    game.chart.update();
}

// ==== Quote & Cipher ====
function loadNewQuote(){
    const authors=["Socrates","Mahatma Gandhi","Albert Einstein","Aristotle"];
    const author = authors[Math.floor(Math.random()*authors.length)];
    WikiquoteApi.getRandomQuote(author,
        function(res){
            game.solution=res.quote.toUpperCase().replace(/[^A-Z ]/g,'');
            game.author=res.titles;
            generateCipher();
            renderCipher();
            resetTimer();
            solutionContainer.style.display="none";
        },
        function(err){
            console.warn("Wikiquote failed:",err);
            fallbackQuote();
        }
    );
}

function fallbackQuote(){
    const q=["THE ONLY TRUE WISDOM IS IN KNOWING YOU KNOW NOTHING","BE THE CHANGE THAT YOU WISH TO SEE IN THE WORLD"];
    const a=["SOCRATES","MAHATMA GANDHI"];
    const i=Math.floor(Math.random()*q.length);
    game.solution=q[i];
    game.author=a[i];
    generateCipher();
    renderCipher();
    resetTimer();
    solutionContainer.style.display="none";
}

function generateCipher(){
    const alph="ABCDEFGHIJKLMNOPQRSTUVWXYZ".split("");
    const shuffled=[...alph].sort(()=>Math.random()-0.5);
    const mapping={};
    for(let i=0;i<alph.length;i++) mapping[alph[i]]=shuffled[i];
    game.cipherText=[...game.solution].map(ch=>ch===" "? "":mapping[ch]).join("");
    game.mapping={};
    for(const c of shuffled) game.mapping[c]="";
}

// ==== Rendering ====
function renderCipher(){
    lettersDiv.innerHTML="";
    [...game.cipherText].forEach((ch,i)=>{
        const container=document.createElement("div");
        container.className="cipher-char-container";
        const letterDiv=document.createElement("div");
        letterDiv.className="cipher-char";
        letterDiv.textContent=ch||" ";
        const input=document.createElement("input");
        input.className="cipher-input";
        input.maxLength=1;
        input.dataset.i=i;
        container.appendChild(letterDiv);
        container.appendChild(input);
        lettersDiv.appendChild(container);
    });

    document.querySelectorAll(".cipher-input").forEach(inp=>{
        inp.addEventListener("input", handleInput);
        inp.addEventListener("keydown", handleNavigation);
    });
    updateChart();
}

// ==== Input Handling ====
function handleInput(e){
    const box=e.target;
    const i=parseInt(box.dataset.i);
    const val=box.value.toUpperCase().replace(/[^A-Z]/g,"");
    box.value=val;
    game.mapping[game.cipherText[i]]=val;
    updateAllMatching(game.cipherText[i]);
    checkSolved();
    if(val) focusNextInput(i);
}

function handleNavigation(e){
    const inputs=Array.from(document.querySelectorAll(".cipher-input"));
    const i=parseInt(e.target.dataset.i);
    switch(e.key){
        case "ArrowRight": focusNextInput(i); e.preventDefault(); break;
        case "ArrowLeft": focusPrevInput(i); e.preventDefault(); break;
        case "ArrowDown": focusNextInput(i); e.preventDefault(); break;
        case "ArrowUp": focusPrevInput(i); e.preventDefault(); break;
        case "Backspace": if(!e.target.value) focusPrevInput(i); break;
    }
}

function focusNextInput(i){
    const next=[...document.querySelectorAll(".cipher-input")].find(inp=>parseInt(inp.dataset.i)>i);
    if(next) next.focus();
}
function focusPrevInput(i){
    const all=[...document.querySelectorAll(".cipher-input")];
    for(let j=all.length-1;j>=0;j--) if(parseInt(all[j].dataset.i)<i){ all[j].focus(); break; }
}
function updateAllMatching(cipher){
    const val=game.mapping[cipher];
    document.querySelectorAll(".cipher-input").forEach(box=>{
        if(game.cipherText[box.dataset.i]===cipher) box.value=val;
    });
}

function checkSolved(){
    for(let i=0;i<game.solution.length;i++){
        const plain=game.solution[i];
        if(plain==="") continue;
        if(game.mapping[game.cipherText[i]]!==plain) return false;
    }
    clearInterval(game.timer);
    game.score+=50;
    scoreValue.textContent=game.score;
    solutionText.textContent=`"${game.solution}" – solved in ${formatTime(game.time)}`;
    authorText.textContent=`– ${game.author}`;
    solutionContainer.style.display="block";
}

// ==== Timer ====
function resetTimer(){ clearInterval(game.timer); game.time=0; timerValue.textContent="00:00";
game.timer=setInterval(()=>{ game.time++; timerValue.textContent=formatTime(game.time); },1000); }
function formatTime(t){ const m=String(Math.floor(t/60)).padStart(2,"0"); const s=String(t%60).padStart(2,"0"); return `${m}:${s}`; }

// ==== Buttons ====
document.getElementById("new-quote-btn").onclick=loadNewQuote;
document.getElementById("solve-btn").onclick=()=>{ [...document.querySelectorAll(".cipher-input")].forEach((b,i)=>b.value=game.solution[i]); solutionContainer.style.display="block"; };

// ==== Init ====
window.onload=()=>{ initChart(); loadNewQuote(); };
</script>
</body>
</html>
