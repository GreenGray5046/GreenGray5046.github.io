<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Aristocrat Cipher Game</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<style>
* { margin:0; padding:0; box-sizing:border-box; font-family:'Times New Roman', Times, serif; }
body { background:#fff; color:#000; min-height:100vh; padding:20px; display:flex; justify-content:center; }
.container { max-width:1000px; width:100%; background:#fff; padding:25px; border:2px solid #000; }
h1 { text-align:center; margin-bottom:20px; font-size:2rem; text-decoration:underline; }
.game-info { display:flex; justify-content:space-between; margin-bottom:16px; gap:8px; flex-wrap:wrap; }
.score, .timer { background:#f0f0f0; padding:10px 14px; font-weight:bold; border:1px solid #000; }
.cipher-container { background:#f8f8f8; padding:18px; border:1px solid #000; }
.cipher-row { display:flex; flex-wrap:wrap; justify-content:center; margin-bottom:8px; }
.cipher-char-container { display:flex; flex-direction:column; align-items:center; margin:0 3px; }
.cipher-char { width:36px; text-align:center; font-size:1.6rem; letter-spacing:2px; }
.cipher-input { width:36px; text-align:center; border:1px solid #000; font-size:1.2rem; height:32px; text-transform:uppercase; }
.space-block { width:20px; margin:0 3px; }
.controls { display:flex; gap:12px; justify-content:center; flex-wrap:wrap; margin:12px 0 14px 0; }
button { background:#f0f0f0; border:1px solid #000; padding:10px 16px; cursor:pointer; font-weight:bold; }
.frequency-chart-container { background:#f8f8f8; padding:12px; margin-top:16px; height:260px; border:1px solid #000; }
.solution-container { background:#f8f8f8; padding:12px; margin-top:16px; display:none; border:1px solid #000; }
.solution-text { font-size:1.2rem; text-align:center; }
.author { text-align:right; font-style:italic; margin-top:8px; font-size:1rem; }
</style>
</head>
<body>
<div class="container">

<h1>Aristocrat Cipher Game</h1>

<div class="game-info">
    <div class="score">Score: <span id="score-value">0</span></div>
    <div class="timer">Time: <span id="timer-value">00:00</span></div>
</div>

<div class="cipher-container">
    <div class="cipher-row" id="cipher-letters"></div>
    <div class="controls">
        <button id="new-quote-btn">New Quote</button>
    </div>
</div>

<div class="frequency-chart-container">
    <canvas id="frequency-chart"></canvas>
</div>

<div class="solution-container" id="solution-container">
    <div class="solution-text" id="solution-text"></div>
    <div class="author" id="author"></div>
</div>

</div>

<script>
// ===== Wikiquote API helper =====
const WikiquoteApi = (() => {
    const API_URL = "https://en.wikiquote.org/w/api.php";

    function queryTitles(title, success, error) {
        $.ajax({
            url: API_URL,
            dataType: "jsonp",
            data: {format:"json", action:"query", redirects:"", titles:title},
            success: function(result){
                const pages = result.query.pages;
                for(let p in pages) if(!("missing" in pages[p])) { success(pages[p].pageid); return; }
                error("No results");
            },
            error: () => error("Failed to query title")
        });
    }

    function getSections(pageId, success, error) {
        $.ajax({
            url: API_URL,
            dataType: "jsonp",
            data: {format:"json", action:"parse", prop:"sections", pageid:pageId},
            success: function(result){
                const sections = result.parse.sections;
                const secArr = [];
                for(let s in sections){
                    const splitNum = sections[s].number.split('.');
                    if(splitNum.length>1 && splitNum[0]==="1") secArr.push(sections[s].index);
                }
                if(secArr.length===0) secArr.push("1");
                success({title:result.parse.title, sections:secArr});
            },
            error: () => error("Failed to get sections")
        });
    }

    function getQuotes(pageId, section, success, error) {
        $.ajax({
            url: API_URL,
            dataType: "jsonp",
            data: {format:"json", action:"parse", pageid:pageId, section:section, noimages:""},
            success: function(result){
                const html = result.parse.text["*"];
                const $lis = $('<div>').html(html).find('li:not(li li)');
                const quotes = [];
                $lis.each(function(){
                    $(this).children().remove(':not(b)');
                    const $b = $(this).find('b');
                    quotes.push($b.length>0 ? $b.html() : $(this).text());
                });
                success({title:result.parse.title, quotes});
            },
            error: () => error("Failed to get quotes")
        });
    }

    function getRandomQuote(author, success, error){
        queryTitles(author, pageId=>{
            getSections(pageId, sec=>{
                const secIndex = sec.sections[Math.floor(Math.random()*sec.sections.length)];
                getQuotes(pageId, secIndex, res=>{
                    const q = res.quotes[Math.floor(Math.random()*res.quotes.length)];
                    success({title:res.title, quote:q});
                }, error);
            }, error);
        }, error);
    }

    return { getRandomQuote };
})();

// ===== Game state =====
const game = {
    score:0, time:0, timer:null,
    solution:"", author:"",
    cipherText:"", cipherAlphabet:"",
    mapping:{}, chart:null
};
const lettersDiv = document.getElementById("cipher-letters");
const scoreValue = document.getElementById("score-value");
const timerValue = document.getElementById("timer-value");
const solutionContainer = document.getElementById("solution-container");
const solutionText = document.getElementById("solution-text");
const authorText = document.getElementById("author");

// ===== Chart =====
function initChart() {
    game.chart = new Chart(document.getElementById("frequency-chart"), {
        type:"bar",
        data:{labels:[], datasets:[{data:[], backgroundColor:'rgba(0,0,0,0.5)'}]},
        options:{responsive:true, maintainAspectRatio:false, plugins:{legend:{display:false}}}
    });
}
function updateChart() {
    const freq={};
    for(const ch of game.cipherText) if(ch!==" ") freq[ch]=(freq[ch]||0)+1;
    const arr = Object.entries(freq).sort((a,b)=>b[1]-a[1]);
    game.chart.data.labels = arr.map(e=>e[0]);
    game.chart.data.datasets[0].data = arr.map(e=>e[1]);
    game.chart.update();
}

// ===== Cipher =====
function generateCipher() {
    game.solution = game.solution.toUpperCase().replace(/[^A-Z ]/g,'');
    const alph="ABCDEFGHIJKLMNOPQRSTUVWXYZ".split("");
    const shuffled=[...alph].sort(()=>Math.random()-0.5);
    const map = {};
    for(let i=0;i<alph.length;i++) map[alph[i]] = shuffled[i];
    game.cipherAlphabet = shuffled.join("");
    game.cipherText = [...game.solution].map(ch=>ch===" "? " ": map[ch]).join("");
    game.mapping = {};
    for(const c of shuffled) game.mapping[c] = "";
}

// ===== Render cipher =====
function renderCipher() {
    lettersDiv.innerHTML="";
    [...game.cipherText].forEach((ch,i)=>{
        if(ch===" "){ lettersDiv.innerHTML+="<div class='space-block'></div>"; return; }
        const container = document.createElement("div");
        container.className="cipher-char-container";
        const letterDiv = document.createElement("div");
        letterDiv.className="cipher-char"; letterDiv.textContent=ch;
        const input = document.createElement("input");
        input.className="cipher-input"; input.maxLength=1; input.dataset.i=i;
        input.addEventListener("input", handleInput);
        input.addEventListener("keydown", handleNavigation);
        container.appendChild(letterDiv);
        container.appendChild(input);
        lettersDiv.appendChild(container);
    });
    updateChart();
    focusFirstBox();
}

// ===== Input =====
function handleInput(e){
    const box = e.target;
    const i = parseInt(box.dataset.i);
    const cipherLetter = game.cipherText[i];
    const val = box.value.toUpperCase().replace(/[^A-Z]/g,'');
    game.mapping[cipherLetter] = val;

    // Auto-fill all same cipher letters
    document.querySelectorAll(".cipher-input").forEach(b=>{
        if(game.cipherText[b.dataset.i]===cipherLetter) b.value = val;
    });

    if(val) moveFocusNext(i);
    checkSolved();
}

// ===== Navigation =====
function handleNavigation(e){
    const i = parseInt(e.target.dataset.i);
    const boxes = Array.from(document.querySelectorAll(".cipher-input"));
    switch(e.key){
        case "ArrowRight": e.preventDefault(); if(i+1<boxes.length) boxes[i+1].focus(); break;
        case "ArrowLeft": e.preventDefault(); if(i-1>=0) boxes[i-1].focus(); break;
        case "ArrowUp": e.preventDefault(); moveVertical(i,-1); break;
        case "ArrowDown": e.preventDefault(); moveVertical(i,1); break;
        case "Backspace": 
            if(!e.target.value && i>0){ boxes[i-1].focus(); boxes[i-1].value=""; }
            break;
    }
}
function moveVertical(i, dir){
    const boxes = Array.from(document.querySelectorAll(".cipher-input"));
    const perRow = Math.max(Math.floor(lettersDiv.offsetWidth/40),1);
    let target = i + dir*perRow;
    if(target<0) target=0;
    if(target>=boxes.length) target=boxes.length-1;
    boxes[target].focus();
}

// ===== Focus =====
function focusFirstBox(){ const first=document.querySelector(".cipher-input"); if(first) first.focus(); }

// ===== Check solved =====
function checkSolved(){
    for(let i=0;i<game.solution.length;i++){
        if(game.solution[i]===" ") continue;
        if(game.mapping[game.cipherText[i]]!==game.solution[i]) return false;
    }
    clearInterval(game.timer);
    game.score += 50; scoreValue.textContent = game.score;
    solutionText.textContent = `"${game.solution}" – solved in ${formatTime(game.time)}`;
    authorText.textContent = `– ${game.author}`;
    solutionContainer.style.display = "block";
}

// ===== Timer =====
function resetTimer(){
    clearInterval(game.timer); game.time=0; timerValue.textContent="00:00";
    game.timer = setInterval(()=>{ game.time++; timerValue.textContent=formatTime(game.time); },1000);
}
function formatTime(t){ return `${String(Math.floor(t/60)).padStart(2,"0")}:${String(t%60).padStart(2,"0")}`; }

// ===== Load new quote =====
function loadNewQuote(){
    const authors=["Socrates","Mahatma Gandhi","Albert Einstein","Aristotle","Confucius"];
    const author = authors[Math.floor(Math.random()*authors.length)];
    WikiquoteApi.getRandomQuote(author, function(result){
        game.solution = result.quote.toUpperCase().replace(/[^A-Z ]/g,'');
        game.author = result.title;
        generateCipher(); renderCipher(); resetTimer(); solutionContainer.style.display="none";
    }, function(){
        // fallback
        const fallback = {quote:"THE ONLY TRUE WISDOM IS IN KNOWING YOU KNOW NOTHING", author:"SOCRATES"};
        game.solution = fallback.quote; game.author = fallback.author;
        generateCipher(); renderCipher(); resetTimer(); solutionContainer.style.display="none";
    });
}

// ===== Init =====
window.onload = () => { initChart(); loadNewQuote(); };
document.getElementById("new-quote-btn").onclick = loadNewQuote;
</script>
</body>
</html>
